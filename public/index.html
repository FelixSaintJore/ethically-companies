<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Ethically · V0</title>
    <style>
        /* root cible la balise <html>, reglages par defauts */
        :root { 
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            color: #1c2331;
            background-color: #eef2f7;
        }
        * {
            /* * = selecteur universel, s'applique a ts les elems de la page (a, p, div...) 
                box-sizing: border-box permet d'inclure le padding et la bordure dans la largeur totale d'un element
            */
            box-sizing: border-box;
        }
        body {
            margin: 0;
            background-color: #eef2f7;
        }
        header {
            background: linear-gradient(120deg, #003c7a, #005bb5);
            color: #fff;
            padding: 40px 20px;
        }
        header .wrapper {
            max-width: 900px;
            margin: 0 auto;
        }
        header h1 {
            margin: 0 0 10px;
            font-size: 2.3rem;
        }
        header p {
            margin: 0;
            line-height: 1.5;
        }
        main {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px 40px;
        }

        #annuaire a:link {
            color : #005bb5
        }
        #annuaire a:visited {
            color : #005bb5
        }

        .search-box, .results .card, .directory {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
        }
        .search-box {
            margin-bottom: 25px;
        }
        label {
            font-weight: 600;
        }
        .search-controls {
            display: flex;
            gap: 12px;
            margin: 12px 0 10px;
        }
        .search-controls input {
            flex: 1;
            padding: 12px 14px;
            border-radius: 8px;
            border: 1px solid #c9d3e0;
            font-size: 1rem;
        }
        .search-controls button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background-color: #005bb5;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }
        .search-controls button:hover {
            background-color: #00478c;
        }
        .stats {
            margin: 6px 0;
            color: #4b5671;
        }
        .stats span {
            font-weight: 700;
        }
        .directory-link {
            display: inline-block;
            margin-top: 4px;
            color: #005bb5;
            text-decoration: none;
            font-weight: 600;
        }
        .directory-link:hover {
            text-decoration: underline;
        }
        .results {
            display: grid;
            gap: 20px;
        }
        .results .placeholder {
            color: #6b7280;
            margin: 0;
        }
        .card header h3 {
            margin: 0;
            font-size: 1.4rem;
        }
        .card header p {
            margin: 4px 0;
            color: white;
        }
        .card p {
            line-height: 1.5;
            
        }
        .card-links-title {
            font-weight: 600;
            margin-top: 12px;
            margin-bottom: 6px;
        }
        .article-links {
            padding-left: 18px;
            margin: 0;
        }
        .article-links li {
            margin-bottom: 4px;
        }
        .article-links a {
            color: #005bb5;
            text-decoration: none;
        }
        .article-links a:hover {
            text-decoration: underline;
        }
        .directory {
            margin-top: 30px;
        }
        .directory h2 {
            margin-top: 0;
        }
        .directory ul {
            list-style-position: inside;
            padding-left: 0;
            margin: 0;
            color: #475069;
        }
        .directory li {
            margin-bottom: 6px;
        }
        @media (max-width: 600px) {
            .search-controls {
                flex-direction: column;
            }
            .search-controls button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="wrapper">
            <h1>Shop Ethically</h1>
            <p>Identifiez la maison mère d'une marque, ses controverses majeures et accédez rapidement aux sources.</p>
        </div>
    </header>

    <main>
        <section class="search-box">
            <label for="brandInput">Rechercher une marque :</label>
            <div class="search-controls">
                <input id="brandInput" type="text" placeholder="Ex : Coca-Cola, Mars..." autocomplete="off">
                <button id="searchBtn" type="button">Rechercher</button>
            </div>
            <p class="stats"><span data-company-count>0</span> entreprises référencées</p>
            <a class="directory-link" href="#annuaire">Voir l'annuaire complet →</a>
        </section>

        <section id="results" class="results">
            <p class="placeholder">Entrez le nom d'une marque pour afficher son entreprise mère.</p>
        </section>

        <section id="annuaire" class="directory">
            <h2>Annuaire des marques et entreprises référencées</h2>
            <ul data-directory></ul>
        </section>
    </main>

    <script>
        let catalog = []; // pour stocker les données du catalogue
        let catalogLoaded = false; // indicateur du téléchargement

        const statsCount = document.querySelector('[data-company-count]'); // pointe et remplace 0 par le vrai count
        const directoryList = document.querySelector('[data-directory]'); // pointe vers l'annuaire
        const resultsNode = document.getElementById('results'); // noeud des resultats
        const brandInput = document.getElementById('brandInput'); // pointe vers champ de texte saisie
        const searchBtn = document.getElementById('searchBtn'); // pointe vers le bouton rechercher

        // --- Tracking Logic ---
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search); // recupere les parametres de l'url
            return urlParams.get(param); 
        }

        const currentUid = getQueryParam('uid');

        async function sendTracking(actionType, actionDetail = '') {
            if (!currentUid) return; 

            try {
                await fetch('/api/track', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uid: currentUid, action_type: actionType, action_detail: actionDetail })
                });
            } catch (e) {
                console.error('Tracking error', e);
            }
        }

        // Track page view
        sendTracking('page_view', window.location.pathname);

        function updateStats() {
            statsCount.textContent = catalog.length;
        }

        function populateDirectory() { // rempli l'annuaire
            directoryList.innerHTML = '';
            if (!catalog.length) {
                const li = document.createElement('li');
                li.textContent = 'Aucune entreprise référencée pour le moment.';
                directoryList.appendChild(li);
                return;
            }

            catalog.forEach((item) => {
                const li = document.createElement('li');
                // const cleanBrand = item.brand.replace(/'/g, "\\'");
                li.innerHTML = `<strong> <a href = "#" class="brand-link" data-brand-name="${item.brand}"> ${item.brand} </a> </strong> — ${item.parent} (${item.sector})`;
                directoryList.appendChild(li);
            });
        }        

        document.getElementById('annuaire').addEventListener('click', (event) => {
        // Check if the clicked element (event.target) is an anchor tag with the required class
            if (event.target.classList.contains('brand-link')) {
                
                // Prevent the default anchor link behavior (i.e., prevent jumping to the top of the page)
                // event.preventDefault(); 
                
                // Get the brand value from the data-brand-name attribute
                const brandValue = event.target.dataset.brandName;
                console.log("brand value = ", brandValue);
                
                // Call the search function with both values
                searchItem(brandValue);
            }
        });
        
        
        function searchItem (brand){
            console.log("searched item : ", brand);
            document.getElementById("brandInput").value = brand;
            document.getElementById("searchBtn").click();
            sendTracking('search', term);
        }





        function renderResults(matches) { // affiche les résultats de la recherche
            if (!matches.length) {
                const query = brandInput.value.trim();
                const message = query ? `Aucun résultat pour « ${query} » pour le moment.` : `Aucune recherche en cours.`;
                resultsNode.innerHTML = `<p class="placeholder">${message}</p>`;
                return;
            }

            resultsNode.innerHTML = matches.map((item) => {
                // We add a class 'track-link' to help identify these links for event delegation if needed, 
                // or just use the onclick attribute for simplicity in this prototype.
                const articleLinks = item.articles
                    .map((article) => `<li><a href="${article.url}" class="external-link" target="_blank" rel="noopener noreferrer">${article.label}</a></li>`)
                    .join('');

                return `
                    <article class="card">
                        <header>
                            <h3>${item.brand}</h3>
                            <p>Maison mère : <strong>${item.parent}</strong></p>
                            <p>${item.sector}</p>
                        </header>
                        <p>${item.summary}</p>
                        <p class="card-links-title">Sources :</p>
                        <ul class="article-links">${articleLinks}</ul>
                    </article>
                `;
            }).join('');
        }

        function handleSearch() { // quand l'utilisateur clique sur rechercher, parcours le catalogue
            if (!catalogLoaded) {
                resultsNode.innerHTML = '<p class="placeholder">Chargement des données...</p>';
                return;
            }

            const term = brandInput.value.trim().toLowerCase();
            if (!term) {
                resultsNode.innerHTML = '<p class="placeholder">Entrez le nom d\'une marque pour afficher son entreprise mère.</p>';
                return;
            }

            // Track search
            sendTracking('search', term);

            const matches = catalog.filter((item) =>
                item.brand.toLowerCase().includes(term) ||
                item.parent.toLowerCase().includes(term)
            );
            renderResults(matches);
        }

        async function loadCatalog() { // chargement des donnees du catalogue
            directoryList.innerHTML = '<li>Chargement...</li>';

            try {
                const response = await fetch('data/catalog.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                catalog = await response.json();
                catalogLoaded = true;
                updateStats();
                populateDirectory();
            } catch (error) {
                console.error('Erreur de chargement du catalogue', error);
                statsCount.textContent = '0';
                directoryList.innerHTML = '<li>Impossible de charger l\'annuaire.</li>';
                resultsNode.innerHTML = '<p class="placeholder">Impossible de récupérer les données pour le moment.</p>';
            }
        }
        
        // ecoute les click sur le bouton rechercher
        // quand ca arrive execute la fonction handleSearch
        searchBtn.addEventListener('click', handleSearch); 

        // ecoute les appuis sur la touche entree dans le champ de texte
        brandInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleSearch();
            }
        });

        // Delegate click events for external links to track them
        // ecoute ce qui se passe dans le noeud des resultats
        resultsNode.addEventListener('click', (event) => {
            if (event.target.tagName === 'A' && event.target.closest('.article-links')) { // lien dans le noeud des resultats
                const url = event.target.href; // recupere l'url du lien cliqué
                sendTracking('click', url); // envoie l'action de clic
            }
        });

        loadCatalog();
    </script>
</body>
</html>
